/* Â©2015 Stephen Chandler Paul <thatslyude@gmail.com>
 *
 * This program is free software; you can redistribute it and/or modify it
 * under the terms of the GNU Lesser General Public License as published by the
 * Free Software Foundation; either version 2 of the License, or (at your
 * option) any later version.

 * This program is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
 * FOR A PARTICULAR PURPOSE. See the GNU Lesser General Public License for more
 * details.
 */

#include "../src/libweechat.h"

#include <glib.h>
#include <stdio.h>

/* This is the test message from the weechat documentation with the header
 * stripped */
unsigned char msg_bin[] = {
  0x63, 0x68, 0x72, 0x41, 0x69, 0x6e, 0x74, 0x00, 0x01, 0xe2, 0x40, 0x69,
  0x6e, 0x74, 0xff, 0xfe, 0x1d, 0xc0, 0x6c, 0x6f, 0x6e, 0x0a, 0x31, 0x32,
  0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x6c, 0x6f, 0x6e, 0x0b,
  0x2d, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x30, 0x73,
  0x74, 0x72, 0x00, 0x00, 0x00, 0x08, 0x61, 0x20, 0x73, 0x74, 0x72, 0x69,
  0x6e, 0x67, 0x73, 0x74, 0x72, 0x00, 0x00, 0x00, 0x00, 0x73, 0x74, 0x72,
  0xff, 0xff, 0xff, 0xff, 0x62, 0x75, 0x66, 0x00, 0x00, 0x00, 0x06, 0x62,
  0x75, 0x66, 0x66, 0x65, 0x72, 0x62, 0x75, 0x66, 0xff, 0xff, 0xff, 0xff,
  0x70, 0x74, 0x72, 0x08, 0x31, 0x32, 0x33, 0x34, 0x61, 0x62, 0x63, 0x64,
  0x70, 0x74, 0x72, 0x01, 0x30, 0x74, 0x69, 0x6d, 0x0a, 0x31, 0x33, 0x32,
  0x31, 0x39, 0x39, 0x33, 0x34, 0x35, 0x36, 0x61, 0x72, 0x72, 0x73, 0x74,
  0x72, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00, 0x03, 0x61, 0x62, 0x63,
  0x00, 0x00, 0x00, 0x02, 0x64, 0x65, 0x61, 0x72, 0x72, 0x69, 0x6e, 0x74,
  0x00, 0x00, 0x00, 0x03, 0x00, 0x00, 0x00, 0x7b, 0x00, 0x00, 0x01, 0xc8,
  0x00, 0x00, 0x03, 0x15
};
unsigned int msg_bin_len = 172;

static char *
wc_type_to_string(LibWCRelayObjectType type) {
	switch (type) {
		case LIBWC_OBJECT_TYPE_CHAR:
			return "Character";
		case LIBWC_OBJECT_TYPE_INT:
			return "Integer";
		case LIBWC_OBJECT_TYPE_LONG:
			return "Long";
		case LIBWC_OBJECT_TYPE_STRING:
			return "String";
		case LIBWC_OBJECT_TYPE_BUFFER:
			return "Buffer";
		case LIBWC_OBJECT_TYPE_POINTER:
			return "Pointer";
		case LIBWC_OBJECT_TYPE_TIME:
			return "Time";
		case LIBWC_OBJECT_TYPE_HASHTABLE:
			return "Hashtable";
		case LIBWC_OBJECT_TYPE_HDATA:
			return "Hdata";
		case LIBWC_OBJECT_TYPE_INFO:
			return "Info";
		case LIBWC_OBJECT_TYPE_INFOLIST:
			return "Infolist";
		case LIBWC_OBJECT_TYPE_ARRAY:
			return "Array";
		default:
			return "???";
	}
}

int main() {
	LibWCRelayMessage *message;
	GError *error = NULL;

	message = libwc_relay_message_parse_data(msg_bin, msg_bin_len, &error);

	for (GList *l = message->objects; l != NULL; l = l->next) {
		LibWCRelayMessageObject *object = l->data;
		GVariant *value;

		printf("Type: %s\n"
			   "Value: %s\n",
			   wc_type_to_string(object->type),
			   g_variant_print(object->value, TRUE));
	}

	return 0;
}
